# 1-3 代理店案件管理（契約進捗管理）システム：本部管理マスタ集約（Upsert同期）

代理店ごとに分散して管理されている「案件管理シート」をDrive上から収集し、本部側の管理マスタ（スプレッドシート）へ集約・最新化する Google Apps Script（GAS）です。  
代理店ID＋店舗IDの複合キーで **Upsert（追加/更新）** を行い、重複や二重管理を防ぎます。

---

## 目的（解決したい課題）
- 代理店ごとに案件管理が分散し、本部側での全体把握・横断集計が難しい
- 手作業での転記・統合はミスや反映遅延が起きやすい
- 同一店舗のデータが複数のファイルに存在し、最新版管理が崩れやすい

本スクリプトにより、フォルダ配下の案件管理シートを定期的に走査し、管理マスタを常に最新状態に保ちます。

---

## できること
- Driveフォルダ配下（サブフォルダ含む）のGoogleスプレッドシートを再帰的に収集
- ファイル名に「案件管理シート」を含むものだけ処理
- 代理店ID＋店舗ID（`AgencyID|StoreID`）をキーとして、以下2シートへUpsert
  - 案件マスター（例：`案件マスター`）
  - CP未反映レコード（例：`CP未反映レコード`）
- 空行の連続検出や最大処理行数制限など、安全策を組み込んだ運用設計
- 例外発生時は `ERROR_LOG` シートへ記録（運用トラブルの追跡が可能）

---

## システムの動作フロー（具体）
1. Script Properties で、集約対象フォルダID（`AGENCY_ROOT_FOLDER_ID`）を設定
2. 指定フォルダ配下のスプレッドシートを再帰的に検索
3. 「案件管理シート」を含むファイルを開き、1枚目のシートを読み取り
4. 必須列（Agency_ID / Store_ID 等）が揃っている行のみ対象とし、キーを生成
5. 本部側マスタ2シートに対して、同じキーでUpsert（既存なら更新、無ければ追記）
6. 完了ログを出力し、エラーは `ERROR_LOG` に記録

---

## 入出力（扱う主な項目）
### ソース（代理店側）で参照するヘッダー例
- `Agency_ID`（代理店ID）
- `Store_ID`（店舗ID）
- `Store_Name`（店舗名）
- `Temp_Store_ID`（temp店舗ID）
- `Tablet_Deviceid`（タブレット端末番号）
- `Tablet_SN`（タブレットSN）

### 反映先（本部マスタ）で使用するヘッダー例
- `代理店ID` / `店舗ID`（必須）
- `店舗名` / `temp店舗ID`（必須）
- `タブレット端末番号` / `タブレットシリアルナンバー`（任意：列があれば反映）

---

## セットアップ
1. 本部側の管理マスタスプレッドシートにApps Scriptを作成し、本コードを配置
2. Script Properties に以下を設定
   - Key：`AGENCY_ROOT_FOLDER_ID`
   - Value：集約対象（代理店案件管理シート群が入った）DriveフォルダID
3. 本部マスタ内に以下のシートを用意（名称はコードの設定に合わせて変更可）
   - `案件マスター`
   - `CP未反映レコード`
4. 実行方法（推奨）
   - 手動実行：`syncAgencySheetsToMaster()`
   - 定期実行：時間主導トリガー（例：毎日/毎時間）で自動同期

---

## セキュリティ（公開用方針）
- DriveフォルダIDなどの機密情報はソースに直書きせず、Script Propertiesで管理します。
- 社内固有名詞は公開用に一般化し、個人情報・顧客情報はリポジトリに含めません。
- 詳細はリポジトリの `docs/security.md` を参照してください。
