# 1-1 タブレット送付通知システム（Tablet Shipping Automation）

二次代理店からのタブレット送付申請を起点に、一次代理店側の発送業務（ステータス管理・送り状作成用データ生成・資産台帳更新・通知）を一連で支援する Google Apps Script（GAS）です。  
スプレッドシート運用に合わせ、担当者の操作は「チェックを入れる」「端末番号を入力する」など最小限で完結する設計です。

---

## 目的（解決したい課題）
- フォーム申請内容の転記作業が多く、転記ミスや反映漏れが起きやすい
- 送り状作成用データ（B2クラウドCSV等）の作成が属人化しやすい
- 端末番号の割当・資産台帳更新が手作業で、更新遅延や整合性崩れが発生しやすい

本システムにより、申請受付から出力生成・台帳反映・ステータス更新までを連動させ、運用の標準化とミス削減を狙います。

---

## できること
- フォーム送信時に、発送管理シートの行を「運用可能な状態」に自動初期化
  - 発送ステータス付与
  - 「発送対象」チェックボックス列の自動生成・入力規則付与
- 「発送対象」をONにすると、B2クラウド出力用CSVシートに1行生成（重複防止あり）
- タブレット番号（From/To）入力に応じて、資産台帳シートを更新（存在しない場合は追記）
- 例外時はエラーログシートへ記録し、運用トラブルの追跡を可能にする
- （任意）Slack等への通知（WebhookはScript Propertiesで管理）

---

## システムの動作フロー（具体）
### 1) 申請受付（フォーム送信）
1. 二次代理店が申請フォームに入力
2. 回答が「タブレット発送管理シート」に追加される
3. `onFormSubmit` トリガーで以下を実行
   - 発送ステータスを `未対応` に設定
   - 「発送対象」列（チェックボックス）が無ければ自動で追加し、列全体にチェックボックス入力規則を付与
   - 新規行のチェックボックスを `false` に初期化

### 2) 送り状データ生成（担当者のチェック操作）
1. 担当者が対象行の「発送対象」をONにする
2. `onEdit` トリガーが検知し、B2クラウド出力用CSVシートに1行分のデータを生成
3. 既に同一内容が出力済みの場合は重複出力しない
4. 出力後、発送管理シート側ステータスを `送り状作成済` に更新

※ 郵便番号・電話番号は先頭0落ちを防ぐため、文字列扱い（表示形式）を設定します。

### 3) 資産台帳更新（端末番号 From/To 入力）
1. 発送管理シートに「タブレット番号 From」「タブレット番号 To」を入力
2. `onEdit` トリガーが検知し、From〜To の範囲で Asset No.（例：W00013201）を連番生成
3. 「社内用資産管理シート」のAsset No.列を参照し、該当行が存在すれば更新、無ければ追記
4. 代理店コード等の管理項目を端末ごとに反映

---

## シート要件（公開用の例）
### タブレット発送管理シート
1行目に以下のヘッダー（列名）が必要です（完全一致）：
- 必要台数
- お届け先住所 / 送付先住所
- 送付先企業名/氏名
- 貴社/貴方の代理店コードをご記入ください
- お届け先電話番号 / お届け先郵便番号 / お届け先建物名（アパートマンション名）
- 発送ステータス
- 発送対象
- タブレット番号 From / タブレット番号 To

### B2クラウド出力用CSV
存在しない場合はスクリプトが自動生成します（13列）。

### 社内用資産管理シート
Asset No.（例：W00013201）が入る列が必要です。その他の列は運用に合わせて調整可能です。

---

## セットアップ
1. スプレッドシートに Apps Script を紐づけ、本コードを配置
2. **インストール型トリガー**として以下を設定
   - `onFormSubmit`：フォーム送信時
   - `onEdit`：編集時
3. （任意）Slack通知を使う場合は Script Properties に Webhook を設定
   - Key：`SLACK_WEBHOOK_URL`
   - Value：Webhook URL（公開リポジトリには含めない）

---

## セキュリティ（公開用方針）
- Webhook URL、スプレッドシートID、社内URL、顧客名などの機密情報はソースに含めず、外部設定（Script Properties）で管理します。
- 公開用の方針詳細はリポジトリの `docs/security.md` を参照してください。

---

## 制約・今後の改善（例）
- 端末番号と店舗情報の紐づけ（店舗名/ID/担当者名）を入力シートに追加し、資産台帳への反映項目を充実させる
- 出力（B2形式）の項目を運用に合わせて拡張（依頼主住所・電話番号など）
- 通知内容のテンプレ化（担当者が一目で判断できる情報設計）

