# Architecture（全体設計）

本リポジトリは、二次代理店〜一次代理店の運用業務を支える業務自動化システム群（Google Apps Script + Google Spreadsheet + Slack）を、公開用に整理したものです。

## 1. 全体像
各システムは「フォーム/入力 → 台帳（Spreadsheet） → 自動処理（GASトリガー） → 出力/通知（Spreadsheet/Slack）」の流れで統一しています。  
運用の中心をスプレッドシートに置き、担当者の作業はチェックや更新など最小限の操作で完結する設計です。

- 入力：Google Forms / Spreadsheet入力
- 処理：Google Apps Script（onFormSubmit / onEdit 等のトリガー）
- 台帳：Google Spreadsheet（申請管理、資産台帳、案件進捗）
- 通知：Slack（Webhook、公開用ではScript Properties管理）

## 2. 構成要素
### 2.1 Google Spreadsheet（運用台帳）
- 申請管理シート：申請内容、ステータス、担当者の操作欄（チェックボックス等）
- 出力シート：外部ツール連携用（例：B2クラウドCSV形式）
- 資産/案件台帳：端末や契約進捗など、社内管理の基礎データ

### 2.2 Google Apps Script（自動化ロジック）
- フォーム送信イベントで初期化（ステータス付与、入力規則付与など）
- セル編集イベントで処理実行（チェックONで出力生成、番号入力で台帳更新など）
- エラー時はログシートへ記録し、運用で追跡可能にする

### 2.3 Slack（通知）
- 申請や依頼の発生をチャンネルへ通知し、対応の抜け漏れを防止
- Webhook URL等の機密は公開用としてソースに含めず、Script Propertiesで管理

## 3. システム別の役割

### 3.1 1-1 タブレット送付通知システム
**目的：** 端末送付の申請受付〜送り状出力〜資産台帳更新を連動させ、転記ミスと処理遅延を削減する。  
**主なデータ流れ：**
1) フォーム入力 → 発送管理シートに行追加  
2) 初期化：発送ステータス付与、チェックボックス列の自動整備  
3) 担当者が「発送対象」をON → B2クラウド出力用CSVを1行生成（重複防止）  
4) 端末番号From/To入力 → 資産管理シートの該当端末行を更新（存在しなければ追記）  
5) 必要に応じてSlack通知（公開用ではダミー/プロパティ管理）

### 3.2 1-2 名刺作成依頼通知システム
**目的：** 名刺作成依頼の受付〜通知〜「通知済み」管理を自動化し、依頼対応の漏れ・重複通知を防止する。  
**主なデータ流れ：**
1) フォーム入力 → 回答シート（例：フォームの回答 1）に行追加  
2) 初期整備：必要に応じて「通知済み」列を自動追加  
3) `onFormSubmit` トリガーで、氏名（キー列）が入力されている未通知行をSlackへ通知  
4) 通知成功後、該当行の「通知済み」を `済` に更新し、以降の重複通知を防止  
5) 追加編集対応：`onEdit` トリガーで、指定した重要列（氏名/役職/電話/メール/住所など）が編集された場合、未通知であれば通知処理を実行  
6) 手動疎通確認：Slack疎通テスト（ping）や、アクティブ行を通知するテスト関数を用意し、運用開始時の確認を容易にする  
7) セキュリティ：Slack Webhookは Script Properties（`SLACK_WEBHOOK_URL`）で管理し、公開用ではソースへ直書きしない

### 3.3 1-3 代理店案件管理（契約進捗管理）システム
**目的：** 代理店ごとに分散した「案件管理シート」の情報を、本部側の管理マスタへ集約・最新化し、横断的な把握と進捗管理を可能にする。  
**主なデータ流れ：**
1) Drive上の特定フォルダ配下（サブフォルダ含む）にある、代理店別の案件管理スプレッドシートを再帰的に収集  
2) ファイル名に「案件管理シート」を含むものを対象とし、各ファイルの1枚目シートを読み取る  
3) ソース側の必須列（例：`Agency_ID`, `Store_ID`, `Store_Name`, `Temp_Store_ID`, `Tablet_Deviceid`, `Tablet_SN`）の位置をヘッダーから特定  
4) 本部側マスタ（当該スクリプトをバインドしたスプレッドシート）の2シートへ反映  
   - `案件マスター（TEST）`：案件の正本となる集約テーブル  
   - `CP未反映の代理店レコード（TEST）`：未反映データの管理・棚卸し用テーブル  
5) 代理店ID＋店舗IDの複合キー（`代理店ID|店舗ID`）で Upsert（追加/更新）を実施  
   - 既存キーがあれば該当行を更新  
   - 無ければ末尾に追記  
6) 運用上の安全策：空行が連続した場合の打ち切り（例：10行連続空で終了）、最大処理行数制限（例：2000行/シート）により、無駄な走査や負荷を抑制  
7) データ品質対策：キーが欠ける行や `#REF!` を含む行はスキップし、マスタの整合性を担保  
8) 実行ログ：追加・更新件数、処理ファイル数などをログ出力し、実行結果を追跡可能にする  
9) セキュリティ：フォルダIDなどの機密情報は公開用ではプロパティ管理（Script Properties）とし、ソースへ直書きしない
